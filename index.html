<html>
<header>
    <script src="samples/ISSTHWatsonResults.js"></script>
    <script src="lib/verge.js"></script>
    <script src="https://unpkg.com/most-visible@latest/dist/most-visible.js"></script>

    <style>
        html,
        body {
            height: 100%;
            overflow: hidden;
        }
        
        .wrapper {
            overflow: auto;
            /*padding-top: 25px;*/
            height: 100%;
            /*position: relative;*/
            /*z-index:9999*/
        }
        
        .footer {
            position: fixed;
            bottom: 0;
            background-color: white;
            width: 100%;
        }
        
        #audiofile {
            width: 100%;
        }
    </style>

</header>

<body>
    
    <div class="footer">
        <audio id="audiofile" src="samples/ISSTH1364.ogg" controls="" preload="metadata"></audio>
    </div>

    <!--<script>
        var audio = document.getElementById('audiofile');
        var req = new XMLHttpRequest();
        req.open('GET', 'http://localhost:7001/issth', true);
        req.responseType = 'blob';

        req.onload = function () {
            // Onload is triggered even on 404
            // so we need to check the status code
            if (this.status === 200) {
                var audioBlob = this.response;
                var aud = URL.createObjectURL(audioBlob); // IE10+
                // Video is now downloaded
                // and we can set it as source on the video element
                audio.src = aud;
            }
        }
        req.onerror = function () {
            // Error
        }

        req.send();

    </script>-->

    <div class="wrapper">

        <div id='chap'>
            <p id="subtitles"> Chapter 1364: Demon and Immortal! The war of the Mountain and Sea Realm continued. The sun had lost Meng Hao,
                so Paragon Sea Dream arranged for the Lord of the Eighth Mountain and Sea Meng Hao’s grandfather, to temporarily
                take control. The 100,000 cultivators were reinforced, and under Grandpa Meng’s control, the sun once again
                became a powerful weapon and threat. The army of Outsiders did not enter the First Sea en masse to fight.
                They were split into five divisions, each one of which was directed by an Imperial Lord. In addition to that,
                various Dao Realm experts were also placed within those forces. Currently, the group fighting with the Mountain
                and Sea cultivators in the First Sea consisted of the first division of several million Outsiders. The First
                Sea was almost completely dried up, and so stained with blood that the redness would never be expunged. The
                reek of gore filled the air, and the brutality of battle caused the starry sky to grow dark. Even the dazzling
                glow caused by the unleashing of divine abilities and magical techniques was darkened by the sea of blood.
                Only hoarse shouts and shrill screams could be heard echoing out constantly across the battlefield. The only
                reason that the first line of defense hadn’t been broken was because the darkness-cloaked Outsider Paragon
                was a cautious person, and his deepest instinct and inclination was to keep buying time. Were it not for
                that, he might have resorted to using the land masses to strike the Mountain and Sea Realm. In fact, if Paragon
                Xuan Fang hadn’t been sealed, the battle being fought would have been a hundred times more brutal. Actually,
                it was because of the cautious decisions being made by the other Paragon, that Sea Dream chose to utilize
                one particular stratagem ahead of schedule, long before the second division of Outsiders launched an offensive….
                The Mountain and Sea cultivators who made up the first line of defense, despite having reinforcements to
                relieve them, were gradually growing exhausted. Furthermore, the First Sea was on the verge of being completely
                dried up. The Mountain and Sea cultivators were pushed back relentlessly, and soon, the second division of
                Outsiders began to advance into battle. Even as that second division set foot into the First Sea, Paragon
                Sea Dream’s eyes glittered. Without any hesitation, she performed an incantation gesture, sending an order
                out to Xu Qing. In turn, Xu Qing suppressed her concern for Meng Hao, and excitedly passed the order along
                to the army. Soon, magical symbols began to glitter throughout the sea of blood that was the First Sea. Waves
                kicked up, and then the First Sea… unexpectedly… self-detonated! Although not much sea water was left in
                it, it was still a sea. Most importantly, the First Sea had its will, which was really a part of the will
                of the Mountain and Sea Realm as a whole. In fact, the self-detonation of the First Sea was, most accurately
                speaking, a detonation of the will of the First Sea. Rumbling could be heard as the water in the First Sea
                began to bubble and seethe. Then, destructive power exploded out from every drop of water, from every wave,
                from every part of the entire sea! BOOOOMMMMMM! The resulting explosion caused the entire Mountain and Sea
                Realm to shake, even the planets. After a moment of shock, the Paragon from the 6th Heaven took a step forward,
                and then looked grimly in the direction of the First Sea. A terrifying shockwave was spreading out, starting
                from the very middle of the First Sea. There, a black hole appeared, which immediately sent out a terrifying
                gravitational force. It was like the power of Heaven and Earth itself were sucking in the sea of blood, as
                well as numerous Outsiders. The Outsiders were thrown into complete chaos. Their first and second divisions
                were crying out in alarm as they began to spiral toward the black hole. As for the cultivators of the Mountain
                and Sea Realm, even as the gravitational force appeared, something exceedingly powerful grabbed ahold of
                them and pulled them out of the First Sea. The black hole almost appeared to be breathing. It sucked in a
                huge breath, and then… the true power of self-detonation appeared. Massive rumbling could be heard as a huge
                blast swept out across Heaven and Earth. Everywhere it passed, Outsiders screamed as first their flesh and
                blood were flayed, then their bones were crushed, and finally, their Nascent Divinities were transformed
                into ash. The intense power of self-detonation exploded out, and in the blink of an eye, it covered the entire
                area of the First Sea, completely enveloping the forces of the first and second divisions of Outsiders. Few
                were able to flee. Not even ordinary Dao Realm experts or Dao Lords were qualified to do such a thing. Only
                those few who were in the 4-Essences level managed to avoid being enveloped by the insanity of the explosion.
                Heaven and Earth trembled, and the starry sky shook. Outside of the Mountain and Sea Realm, the rest of the
                army was shaken, and stared in terror and shock. Even the six Imperial Lords gasped. The force of the self-detonation
                lasted for three full days, during which time the Mountain and Sea cultivators stood on one side of the sea,
                silent, and the Outsiders stood on the other side, shocked. After three days, the reverberations of the explosion
                died down. The First Sea… would never be seen again for all eternity. The Mountain and Sea Realm had lost
                one of its seas, although along with it went all the Outsiders inside of it. The rest of the Outsiders stood
                there silently, as did the Mountain and Sea cultivators. The First Sea… was gone. For the first time in the
                war, the Mountain and Sea cultivators felt what it was like to lose one of their Mountains or Seas. The sensation…
                left them in a bit of a daze. Soon, though, the fighting continued. The third division of Outsiders was ordered
                into action by their Paragon. This time, two Imperial Lords joined in the fighting, as well as numerous Dao
                Realm experts, all of whom began to advance upon the First Mountain. Only half of the Mountain and Sea Realm’s
                first line of defense remained. The entire First Mountain turned into a battleground, and soon the fierce
                fighting caused the entire mountain to be stained red with blood. Even as the rumbling of battle echoed out,
                Meng Hao remained in a coma, completely unaware of what was happening around him. He was like a drifting
                soul in a strange world. That world had no sky, no land, no trees or plants, no mountains or rivers. There
                was only… a faint mist, within which could be seen… two enormous statues. The facial features of the statues
                were obscured, but one thing that Meng Hao could sense was that the statue on the left pulsed with a Heaven-shaking,
                Earth-shattering Demonic qi! As the Ninth Generation Demon Sealer, Meng Hao could sense how powerful that
                Demonic qi was. Furthermore, it clearly contained some of the aura of the Mountains and Seas. There was something
                strange about it, something multifarious. Even moreso, it possessed a frenzied desire to kill which, contrary
                to expectation, was not deranged and mad, but cold and calculating. The aura which surrounded the statue
                made it extremely bizarre, and even though Meng Hao couldn’t see its face, he was certain that its expression
                was both ferocious and benevolent. It was the type of face that seemed to be crying, and yet laughing at
                the same time. It was as if the statue actually had a thousand faces, making it impossible to tell what emotion
                truly lay within. It was… a Demon. Because of its multifariousness, it became Demonic, and this statue seemed
                as if it were the world’s sole and perfect exemplar of a Demon. As for the statue on the right, when Meng
                Hao looked at it, he could sense an Immortal qi so concentrated that it caused everything in the area to
                tremble. It was as if this were the perfect expression of all Immortals, as if this were the only Immortal
                that existed in the world! Meng Hao looked silently at the two statues, and then glanced around at the world
                which surrounded him. He felt bewildered, unsure of where he was, and confused regarding exactly what these
                two statues depicted. Even as Meng Hao began to question what was happening, an ancient voice spoke to him,
                a voice which seemed to echo out from primeval times, to fill the world in which he stood. “This place… exists
                inside your heart of hearts.” His mind trembled, and he looked up, but could not see the owner of the voice.
                It was as if the voice was everywhere and nowhere. “Look at these two statues. One is the Demon, the other
                is the Immortal…. In the Paragon Immortal Realm, a birth was foreordained… the Vast Expanse’s one and only…
                Immortal…. “That is why the Allheaven bloodline emerged…. “However, there were certain people who did not
                wish for the Immortal to be born. They wanted to supplant that position. That is because, although the Immortal
                and the God complement one another… the Immortal is above the God, and can also suppress the Devil! “The
                God and the Devil cared not, but their descendants cared. Thus, the Heavens were reversed, Karma was altered,
                and time was rifled with. They were willing to pay any price… and they succeeded! Yet, they also failed.
                Furthermore, they were unaware that… because of the changes wrought by the mix of success and failure, they
                unwittingly caused something to happen which should not have. The Immortal… became the Demon…. “That is because
                the world in which the Immortal was to be born, was a world that existed before the Allheaven bloodline had
                appeared. That world… was a world which suppressed the 3,000 Greater Demons. It was… the Paragon Demon Realm!
                “The Demon is multifarious and bizarre. Changeable…. It is not righteous and noble like the Immortal. It
                cannot suppress the Devil, nor can it shake the God…. However, what it can do… is topple the Vast Expanse!
                “And now, the time has come for you to ask yourself, if you had the choice, would you become… the mighty
                and powerful Immortal? Or would you become… the Demon which can topple the Vast Expanse?!” As the ancient
                voice echoed out, it was possible to tell that there was no power of compulsion within it. It simply wished
                to hear an answer to the question. Meng Hao maintained his silence. He looked over at the left-hand statue
                which represented the Demon. Before, the face had not been visible, but now, it suddenly was. What Meng Hao
                found himself looking at… was his own face! He had towering Demonic qi, and eyes that glowed with a redness
                that would never be extinguished. There was no haughty conceit, no extreme domineering air. There was no
                righteous nobility, and there was no dignity. However, there was a multifariousness, a changeability, a bizarreness.
                Furthermore, within those red eyes there was the sensation… of a hatred as fathomless as a sea of blood,
                something that wished to destroy the entire world. And yet, deep within the eyes, concealed beneath the thousand
                multifarious, changeable faces were bitter memories and complex emotions… which could not be discovered,
                nor felt by others…. 1 When Meng Hao looked at the statue of the Demon that had his own face, his heart trembled.
                He could sense the grief within this Demon, as well as an unyielding heart. There was also madness and hatred.
                Meng Hao quietly turned to look at the statue of the Immortal…. This statue also bore his face, a face tranquil,
                calm, and otherworldly. Its gaze seemed warm, but in truth, it was incredibly cold. It was as if, in its
                eyes, everything in Heaven and Earth could be expressed in terms of natural law, as if this Immortal were
                above everything and everyone, the only Immortal in the world. All memories, everything about the past, were
                like impurities from former lives. Everything that happened while treading the path of Immortality would
                be left behind, severed, not allowed to be a hindrance or restraint of any kind. This Immortal was neither
                ruthless nor sentimental. He was neither selfish nor selfless. There was only a certain separation from the
                past, as if, when looking back and recalling old memories, he was unaffected, and would merely sigh lightly.
                Once again, the ancient voice echoed out. “There is no need to speak your answer out loud. As long as it
                exists in your heart, that is enough….”</p>

        </div>

    </div>


    <script>
        // based on Levenshtein distance, it checks the similarity between two words 
        function similarity(s1, s2) {
            var longer = s1;
            var shorter = s2;
            if (s1.length < s2.length) {
                longer = s2;
                shorter = s1;
            }
            var longerLength = longer.length;
            if (longerLength == 0) {
                return 1.0;
            }
            return (longerLength - editDistance(longer, shorter)) / parseFloat(longerLength);
        }

        function editDistance(s1, s2) {
            s1 = s1.toLowerCase();
            s2 = s2.toLowerCase();

            var costs = new Array();
            for (var i = 0; i <= s1.length; i++) {
                var lastValue = i;
                for (var j = 0; j <= s2.length; j++) {
                    if (i == 0)
                        costs[j] = j;
                    else {
                        if (j > 0) {
                            var newValue = costs[j - 1];
                            if (s1.charAt(i - 1) != s2.charAt(j - 1))
                                newValue = Math.min(Math.min(newValue, lastValue),
                                    costs[j]) + 1;
                            costs[j - 1] = lastValue;
                            lastValue = newValue;
                        }
                    }
                }
                if (i > 0)
                    costs[s2.length] = lastValue;
            }
            return costs[s2.length];
        }

        var paragraphs = document.getElementById("chap").querySelectorAll("p");

        var p1 = paragraphs[0];

        var words = p1.innerHTML.split(" ");
        words = words.filter(e => String(e).trim());
        //   console.log(words);
        p1.innerHTML = "";


        var alternativeTimestamps = [];
        var timestamps = [];
        for (let i = 0; i < watsonResults.length; i++) {

            if (watsonResults[i].result_index != i) {
                console.log("missing result:  " + i);
            }
            timestamps = watsonResults[i].results[0].alternatives[0].timestamps;
            alternativeTimestamps = alternativeTimestamps.concat(timestamps);
        }

        console.log(alternativeTimestamps);

        function createMeta(arr) {
            let meta = {};
            for (let i = 0; i < words.length; i++) {
                meta.word = arr[i];
                meta.time_stamp = [];
                meta.time_stamp_index = -1;
                arr[i] = meta;
                meta = {};
            }
        }
        createMeta(words);

        var stampMatch = 0;

        function findMatched(originals, timestamps) {
            for (let o = 0; o < originals.length; o++) {

                var original = originals[o];
                var orgWord = removePunctuation(original.word);
                for (let t = stampMatch; t < timestamps.length; t++) {
                    // consider the ss.. in which case stop 
                    // it fixes it self over time of course 
                    if (t == stampMatch + 8) {
                        // stampMatch = stampMatch + 1;
                        break;
                    }

                    var timestamp = timestamps[t];
                    var transWord = removePunctuation(timestamp[0]);

                    if (orgWord == transWord || similarity(orgWord, transWord) > .75) {
                        original.time_stamp = timestamp;
                        original.time_stamp_index = t;
                        stampMatch = t + 1;
                        break;
                    }
                }
            }
        }

        function fixUnmatched(originals, timestamps) {
            var hasStampIndex = null;
            var nextHasStampIndex = null;

            var prevMatched = null;
            var nextMatched = null;

            for (var i = 0; i < originals.length; i++) {
                hasStampIndex = originals[i].time_stamp_index != -1;

                if (hasStampIndex && prevMatched == null) {
                    prevMatched = i;
                } else if (hasStampIndex && ((prevMatched + 1) == i)) {
                    prevMatched = i;
                }
                else if (hasStampIndex && prevMatched != null) {
                    nextMatched = i;
                }

                if (prevMatched != null && nextMatched != null) {
                    addMissingTimestamps(prevMatched, nextMatched, originals, timestamps);

                    prevMatched = null;
                    nextMatched = null;

                    if (i != originals.length - 1) {
                        nextHasNoStampIndex = originals[i + 1].time_stamp_index == -1;
                        if (nextHasNoStampIndex && prevMatched == null) {
                            prevMatched = i;
                        }
                    }

                }

                if ((i == originals.length - 1) && !hasStampIndex) {
                    var start = originals[prevMatched].time_stamp[2];
                    var end = timestamps[timestamps.length - 1][2];
                    originals[originals.length - 1].time_stamp = ['', start, end];
                }


            }
        }

        function addMissingTimestamps(prevIndex, nextIndex, originals, timestamps) {

            var timeDiff = originals[nextIndex].time_stamp[1] - originals[prevIndex].time_stamp[2];


            var betweenIndexes = [];
            for (let i = prevIndex + 1; i < nextIndex; i++) {
                betweenIndexes.push(i);
            }
            var diff = betweenIndexes.length;

            var totalLength = 0;
            var wordsLengths = [];
            for (let i = 0; i < diff; i++) {
                var word = originals[betweenIndexes[i]].word
                wordsLengths.push(word.length);
                totalLength = totalLength + word.length;
            }

            var timeDistances = [];
            var seconds = 0.0;
            for (let i = 0; i < wordsLengths.length; i++) {
                seconds = (wordsLengths[i] / totalLength) * timeDiff;
                timeDistances.push(seconds);
            }

            var prevEndTime = originals[prevIndex].time_stamp[2];
            var index = 0;
            for (let i = 0; i < diff; i++) {
                originals[betweenIndexes[i]].time_stamp = ['', prevEndTime, prevEndTime + timeDistances[index]];
                prevEndTime = prevEndTime + timeDistances[index];
                index++;
            }
        }


        function removePunctuation(str) {
            var punctuationless = str.trim().replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g, "");
            return (punctuationless.replace(/\s{2,}/g, " ")).toLowerCase().trim();
        }

        findMatched(words, alternativeTimestamps);
        fixUnmatched(words, alternativeTimestamps);
        console.log(words);

        var subtitles = document.getElementById("subtitles");
        function createSubtitleTest(syncData) {
            var element;
            var stamps = [];
            var begin = '';
            var end = '';
            var className = '';
            var idName = '';
            for (var i = 0; i < syncData.length; i++) {
                stamps = syncData[i].time_stamp;
                begin = stamps[1];
                end = stamps[2];

                if (begin != undefined && end != undefined) {
                    idName = 'word_' + i + '_' + begin + '_' + end;
                    begin = Math.floor(begin);
                    className = 'group_' + begin;
                }

                element = document.createElement('span');
                element.setAttribute("id", idName);
                element.setAttribute("class", className + " wordSpan");
                element.innerText = syncData[i].word + " ";
                subtitles.appendChild(element);
            }
        };
        createSubtitleTest(words);

        var audioPlayer = document.getElementById("audiofile");
        var subtitles = document.getElementById("subtitles");
        var syncData = words;
        var currTime = 0.0;
        var flatTime = 0.0;
        var prevFlatTime = -1.0;
        var className = '';
        var elements;
        var prevElements;
        var scrolled = false;

        audioPlayer.addEventListener("timeupdate", function (e) {
            currTime = audioPlayer.currentTime;
            flatTime = Math.floor(currTime);

            if (flatTime != prevFlatTime) {
                className = 'group_' + flatTime;
                elements = document.getElementsByClassName(className);
                for (let i = 0; i < elements.length; i++) {
                    elements[i].style.background = 'yellow';
                    if (!verge.inViewport(elements[i])) {
                        elements[i].scrollIntoView(true);
                        scrolled= true;
                    }
                }
            }

            // unhilight prev word or phrase
            if (flatTime > prevFlatTime || flatTime < prevFlatTime) {
                className = 'group_' + prevFlatTime;
                elements = document.getElementsByClassName(className);
                for (let i = 0; i < elements.length; i++) {
                    elements[i].style.background = '';
                }
                prevFlatTime = flatTime;
            }

            console.log(currTime);

        });


        var wordSpans = document.querySelectorAll('.wordSpan');

        var topWordSpan = null;
        var wordTimeStamp = null;
        // Update player based on top most word
        window.addEventListener('scroll', function (e) {
            if(scrolled){
                scrolled =false;
            }
            else{
                topWordSpan = mostVisible(wordSpans);
                wordTimeStamp = topWordSpan.getAttribute('class').split(" ")[0].split('_')[1];
                audioPlayer.currentTime = wordTimeStamp;
            }
            
        }, true);
    </script>
</body>

</html>